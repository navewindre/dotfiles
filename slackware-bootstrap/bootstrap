#!/bin/bash
basedir=$( cd -- "$( dirname -- "${BASH_SOURCE[0]}" )" &> /dev/null && pwd )
username="user"

kernelver="6.15.2"
hasuser=0

while getopts u:a:f: flag
do
    case "${flag}" in
        u) username=${OPTARG}
          hasuser=1
          ;;
    esac
done

if [[ $hasuser == 0 ]]; then
  read -p "WARNING: username not provided. continue? [y/n] (n):" choice
  if [[ $choice != "y" ]]; then
    exit 1
  fi
fi

echo "working dir: $basedir"

sh $basedir/user $username
sh $basedir/sudo
sh $basedir/slackpkg
sh $basedir/slpkg
sh $basedir/multilib

echo "============== [ kernel update ] ==============="
echo "you can choose to update your kernel"
echo "after system reboot."
echo "this will update your kernel to $kernelver"
echo "================================================"

nreboot=0

read -p "do you want to update your kernel [y/n]? (y):" choice
if [[ $choice == "y" ]]; then
  nreboot=1
  echo "sh $basedir/kernel" >> /root/.bashrc
fi

echo "================= [ nvidia driver ] ================="
echo "you can choose to install the nvidia driver"
echo "after system reboot."
echo "this will install the nvidia kernel module and the"
echo "gpu driver."
echo "====================================================="

read -p "do you want to install the nvidia driver [y/n]? (y):" choice
if [[ $choice == "y" ]]; then
  nreboot=1
  echo "sh $basedir/nvidia-driver" >> /root/.bashrc
fi

if [[ $nreboot == 1 ]]; then
  echo "sh $basedir/finish" >> /root/.bashrc
  echo "rm -f /root/.bashrc" >> /root/.bashrc
  echo "============================ [ reboot ] ==========================="
  printf "\x1b[1;31mupon reboot, make sure to log in as ROOT first !!!\x1b[0;0m\n"
  echo "==================================================================="
  read -p "press enter to reboot your system"
  echo "rebooting..."
  reboot
else
  sh $basedir/runlevel

  echo "============== [ setup done ] ==============="
  echo "username: $username"
  echo "you may now log into your user account."
  echo "it is recommended to reboot your system now."
  echo "=============================================="
fi
